<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Phone Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            font-family: Roboto, "Ubuntu Sans", Arial, sans-serif;
        }
    </style>
    <script>
        // ---------------- SEARCH FUNCTION ----------------
        function getSearch() {
            const searchTerm = document.querySelector("#search").value.toLowerCase();
            console.log(searchTerm)
            
            if (searchTerm.length > 1) {
                fetch("/api/phones/search", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ model: searchTerm }),
                })
                    .then((response) => response.json())
                    .then((phones) => {
                        console.log(phones);
                        renderTable(phones);
                    });
            } else if (searchTerm.length === 0) {
                fetchPhones();
            }
        }

        // ---------------- DELETE FUNCTION ----------------
        function handleDelete(phoneId) {
            if (confirm('Are you sure you want to delete this phone?')) {
                fetch(`/api/phones/${phoneId}`, {
                    method: 'DELETE',
                })
                    .then((response) => response.json())
                    .then((data) => {
                        console.log('Deleted:', data);
                        fetchPhones();
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });
            }
        }

        // ---------------- SAVE FUNCTION ----------------
        function handleSave() {
            updated_phone = {
                phoneid: document.querySelector("#phoneid").value,
                brand: document.querySelector("#brand").value,
                model: document.querySelector("#model").value,
                storage: document.querySelector("#storage").value,
                price: document.querySelector("#price").value,
                status: document.querySelector("#status").value,
            };

            fetch('/api/phones/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updated_phone),
            })
                .then((response) => response.json())
                .then((data) => {
                    console.log('Success:', data);
                    document.querySelector("#edit").style.display = "none";
                    fetchPhones();
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
        }

        // ---------------- EDIT CLICK FUNCTION ----------------
        function handleClick(phoneId) {
            fetch(`/api/phones/${phoneId}`)
                .then((response) => response.json())
                .then((data) => {
                    document.querySelector("#edit").classList.remove("hidden");
                    
                    let html = `
                    <div class="space-y-4">
                        <div class="flex items-center">
                            <label class="w-24 font-semibold text-gray-700">ID</label>
                            <div class="text-gray-600">${data.phoneid}</div>
                            <input type="hidden" id="phoneid" value="${data.phoneid}"/>
                        </div>
                        <div class="flex items-center">
                            <label class="w-24 font-semibold text-gray-700">Brand</label>
                            <input type="text" id="brand" value="${data.brand}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                        </div>
                        <div class="flex items-center">
                            <label class="w-24 font-semibold text-gray-700">Model</label>
                            <input type="text" id="model" value="${data.model}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                        </div>
                        <div class="flex items-center">
                            <label class="w-24 font-semibold text-gray-700">Storage</label>
                            <input type="text" id="storage" value="${data.storage}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                        </div>
                        <div class="flex items-center">
                            <label class="w-24 font-semibold text-gray-700">Price</label>
                            <input type="number" id="price" value="${data.price}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                        </div>
                        <div class="flex items-center">
                            <label class="w-24 font-semibold text-gray-700">Status</label>
                            <select id="status" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="Available" ${data.status === 'Available' ? 'selected' : ''}>Available</option>
                                <option value="Sold" ${data.status === 'Sold' ? 'selected' : ''}>Sold</option>
                                <option value="Restocking" ${data.status === 'Restocking' ? 'selected' : ''}>Restocking</option>
                            </select>
                        </div>
                        <div class="pt-4">
                            <button type="submit" onclick="handleSave()" class="w-full px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition duration-200">Save Changes</button>
                        </div>
                    </div>`;
                    document.querySelector("#edit-content").innerHTML = html;
                });
        }

        // ---------------- HELPER: RENDER TABLE ----------------
        function renderTable(phones) {
            let html = ``;
            phones.forEach((phone) => {
                html += `
                <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition duration-200">
                    <div class="flex items-center justify-between mb-4 pb-3 border-b border-gray-200">
                        <input type="text" placeholder="Search within this item..." class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm" />
                    </div>
                    
                    <div class="space-y-3 mb-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500 text-sm">ID:</span>
                            <span class="font-semibold">${phone.phoneid}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500 text-sm">Brand:</span>
                            <span class="font-semibold">${phone.brand}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500 text-sm">Model:</span>
                            <a href="#!" onclick="handleClick(${phone.phoneid})" class="text-blue-600 hover:text-blue-800 font-semibold">${phone.model}</a>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500 text-sm">Storage:</span>
                            <span class="font-semibold">${phone.storage}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500 text-sm">Price:</span>
                            <span class="font-semibold text-green-600">$${phone.price}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-500 text-sm">Status:</span>
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${phone.status === 'Available' ? 'bg-green-100 text-green-800' : phone.status === 'Sold' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">${phone.status}</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 pt-4 border-t border-gray-200">
                        <button onclick="handleClick(${phone.phoneid})" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition duration-200 text-sm font-medium">Edit</button>
                        <button onclick="handleDelete(${phone.phoneid})" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-200 text-sm font-medium">Delete</button>
                    </div>
                </div>`;
            });
            document.querySelector("#main-grid").innerHTML = html;
        }

        // ---------------- LOAD ALL PHONES ----------------
        function fetchPhones() {
            fetch("/api/phones")
                .then((response) => response.json())
                .then((data) => {
                    console.log(data);
                    renderTable(data);
                });
        }
        
        // Initial Load
        fetchPhones();
    </script>
</head>

<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Main Search Bar -->
        <div class="mb-8">
            <div class="max-w-2xl">
                <input type="text" name="search" id="search" placeholder="Search by model..." oninput="getSearch()" class="w-full px-6 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" />
            </div>
        </div>
        
        <div class="flex gap-8 items-start">
            <!-- Main Inventory Grid -->
            <div class="flex-1">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Phone Inventory</h2>
                <div id="main-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>

            <!-- Edit Panel -->
            <div id="edit" class="hidden w-96 bg-white rounded-lg shadow-lg p-6 sticky top-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Edit Details</h2>
                <div id="edit-content"></div>
            </div>
        </div>
    </div>
</body>

</html>