<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phone Directory</title>

   <script src="https://cdn.tailwindcss.com"></script>
   <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <style>
    .name-font { font-family: "Poppins", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  </style>
</head>
<body class="bg-slate-900 text-slate-100 antialiased">
  <main class="max-w-6xl mx-auto p-6 min-h-screen flex flex-col">
 
    <header class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
      <div>
        <h1 class="text-3xl font-extrabold tracking-tight">Phone Directory</h1>
      </div>

      <div class="flex items-center gap-3 w-full sm:w-auto">
        <input id="search" type="search" placeholder="Search by brand, model, price or ID"
               class="flex-1 sm:flex-none w-full sm:w-80 px-3 py-2 rounded-lg border border-slate-700 bg-slate-800 text-slate-100 text-sm focus:outline-none focus:ring-2 focus:ring-sky-500" />
      </div>
    </header>

 
    <section class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
      <div class="bg-gradient-to-r from-slate-800 to-slate-700 rounded-xl p-4 shadow-md flex items-center gap-4 border border-slate-700">
        <div class="text-3xl"></div>
        <div>
          <div class="text-xs text-slate-300">Total Phones</div>
          <div id="totalCount" class="text-2xl font-semibold">0</div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-slate-800 to-slate-700 rounded-xl p-4 shadow-md flex items-center gap-4 border border-slate-700">
        <div class="text-3xl"></div>
        <div>
          <div class="text-xs text-slate-300">Unique Brands</div>
          <div id="brandCount" class="text-2xl font-semibold">0</div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-slate-800 to-slate-700 rounded-xl p-4 shadow-md flex items-center gap-4 border border-slate-700">
        <div class="text-3xl"></div>
        <div>
          <div class="text-xs text-slate-300">Average Market Price</div>
          <div id="avgPrice" class="text-2xl font-semibold">Rs0</div>
        </div>
      </div>
    </section>


    <section id="formSection" class="hidden bg-slate-800 rounded-xl shadow-md p-5 mb-6 border border-slate-700">
      <h2 id="formTitle" class="text-lg font-medium mb-3">Edit Phone</h2>
      <form id="phoneForm" class="grid grid-cols-1 sm:grid-cols-3 gap-4" autocomplete="off">
        <input type="hidden" id="phoneid" name="phoneid" />

        <div class="sm:col-span-1">
          <label for="brand" class="block text-sm text-slate-300 mb-1">Brand</label>
          <input id="brand" name="brand" required
                 class="w-full px-3 py-2 rounded-md border border-slate-700 bg-slate-900 text-slate-100 focus:outline-none focus:ring-2 focus:ring-emerald-400" />
        </div>

        <div class="sm:col-span-1">
          <label for="model" class="block text-sm text-slate-300 mb-1">Model</label>
          <input id="model" name="model" required
                 class="w-full px-3 py-2 rounded-md border border-slate-700 bg-slate-900 text-slate-100 focus:outline-none focus:ring-2 focus:ring-indigo-400" />
        </div>

        <div class="sm:col-span-1">
          <label for="price" class="block text-sm text-slate-300 mb-1">Market Price (Rs)</label>
          <input id="price" name="price" type="number" min="0" step="1" required
                 class="w-full px-3 py-2 rounded-md border border-slate-700 bg-slate-900 text-slate-100 focus:outline-none focus:ring-2 focus:ring-amber-400" />
        </div>

        <div class="sm:col-span-3 flex justify-end gap-3 mt-2">
          <button type="button" id="cancelBtn" class="px-3 py-2 rounded-md border border-slate-700 bg-slate-800 text-slate-200 text-sm">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded-md bg-gradient-to-r from-sky-600 to-indigo-600 text-white text-sm font-medium hover:from-sky-700 hover:to-indigo-700">Save</button>
        </div>
      </form>
    </section>


    <section class="bg-slate-800 rounded-xl shadow-md p-4 border border-slate-700 flex-1">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-medium text-slate-200">Phone List</h3>
      </div>

      <div class="overflow-x-auto">
        <table id="phonesTable" class="min-w-full text-sm">
          <thead class="bg-slate-800">
            <tr>
              <th class="text-left px-4 py-3 text-slate-300">ID</th>
              <th class="text-left px-4 py-3 text-slate-300">Brand</th>
              <th class="text-left px-4 py-3 text-slate-300">Model</th>
              <th class="text-left px-4 py-3 text-slate-300">Price</th>
              <th class="text-left px-4 py-3 text-slate-300">Actions</th>
            </tr>
          </thead>
          <tbody id="phonesBody" class="divide-y divide-slate-700 bg-slate-900">
           </tbody>
        </table>
      </div>

      <p id="emptyMsg" class="hidden text-center text-slate-400 py-6">No phones found.</p>
    </section>

     <footer class="mt-6 text-slate-300">
      <div class="border-t border-slate-700 pt-6 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
         <div class="sm:w-1/2">
          <div class="text-sm text-slate-400">This project made by</div>
          <div class="mt-3 space-y-1">
            <div class="name-font text-lg text-slate-100">Bisma Sulhary</div>
            <div class="name-font text-lg text-slate-100">Kamran Hussain</div>
          </div>
        </div>

        <div class="sm:w-1/2 text-sm">
          <div class="text-slate-400">Contact & links</div>
          <div class="mt-3 space-y-2">
            <div> <a href="https://mail.google.com/mail/?view=cm&fs=1&to=bismahsulhary@gmail.com"
                    target="_blank" rel="noopener noreferrer"
                    class="text-sky-300 hover:underline">bismahsulhary@gmail.com</a></div>      
            <div> <a href="https://mail.google.com/mail/?view=cm&fs=1&to=sharkamran111@gmail.com"
                    target="_blank" rel="noopener noreferrer"
                    class="text-sky-300 hover:underline">sharkamran111@gmail.com</a></div>                 
            <div>Project repository</div>
            <div class="text-slate-400 text-xs mt-2">Need help or want to contribute? Reach out via email or open an issue on the repo.</div>
          </div>
        </div>
      </div>
    </footer>
  </main>

    <script>
    (function () {
      const phonesBody = document.getElementById('phonesBody');
      const phonesTable = document.getElementById('phonesTable');
      const emptyMsg = document.getElementById('emptyMsg');
      const searchInput = document.getElementById('search');
      const formSection = document.getElementById('formSection');
      const phoneForm = document.getElementById('phoneForm');
      const cancelBtn = document.getElementById('cancelBtn');
      const formTitle = document.getElementById('formTitle');
      const totalCountEl = document.getElementById('totalCount');
      const brandCountEl = document.getElementById('brandCount');
      const avgPriceEl = document.getElementById('avgPrice');

      let phones = [];
      let currentEditingPhone = null;

        async function loadPhones() {
        try {
          const res = await fetch('/api/phones');
          phones = await res.json();
          console.log('Loaded phones:', phones);
        } catch (err) {
          console.error('Failed to load phones', err);
          phones = [];
        }
        renderList(phones);
        updateSummaries(phones);
      }

        function renderList(list) {
        phonesBody.innerHTML = '';
        if (!list || list.length === 0) {
          phonesTable.classList.add('hidden');
          emptyMsg.classList.remove('hidden');
          return;
        }
        phonesTable.classList.remove('hidden');
        emptyMsg.classList.add('hidden');

        list.forEach(p => {
          const tr = document.createElement('tr');
          tr.className = 'hover:bg-slate-800';

            const idTd = document.createElement('td');
          idTd.className = 'px-4 py-3 text-slate-200';
          idTd.textContent = String(p.phoneid || '');
          tr.appendChild(idTd);

  
          const brandTd = document.createElement('td');
          brandTd.className = 'px-4 py-3';
          brandTd.innerHTML = `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-semibold" style="background: ${brandColor(p.brand)}; color: white;">${escapeHtml(p.brand || 'Unknown')}</span>`;
          tr.appendChild(brandTd);

          const modelTd = document.createElement('td');
          modelTd.className = 'px-4 py-3 text-slate-200';
          modelTd.textContent = p.model || '';
          tr.appendChild(modelTd);

  
          const priceTd = document.createElement('td');
          priceTd.className = 'px-4 py-3';
          const priceVal = Number(p.price) || 0;
          const priceColor = priceVal >= 50000 ? 'text-rose-400' : priceVal >= 20000 ? 'text-amber-400' : 'text-emerald-400';
          priceTd.innerHTML = `<span class="text-sm font-semibold ${priceColor}">Rs${priceVal.toLocaleString()}</span>`;
          tr.appendChild(priceTd);

  
          const actionsTd = document.createElement('td');
          actionsTd.className = 'px-4 py-3';

          const editBtn = document.createElement('button');
          editBtn.className = 'px-3 py-1 rounded-md border border-slate-700 text-sm bg-slate-800 text-slate-100 hover:bg-slate-700';
          editBtn.textContent = 'Edit';
          editBtn.addEventListener('click', () => openEdit(p));
          actionsTd.appendChild(editBtn);

          tr.appendChild(actionsTd);
          phonesBody.appendChild(tr);
        });
      }

  
      function updateSummaries(list) {
        totalCountEl.textContent = list.length;
        const brands = new Set(list.map(p => (p.brand || '').trim()).filter(Boolean));
        brandCountEl.textContent = brands.size;

        const prices = list.map(p => Number(p.price) || 0).filter(v => v > 0);
        const avg = prices.length ? Math.round(prices.reduce((a,b)=>a+b,0)/prices.length) : 0;
        avgPriceEl.textContent = `Rs${avg.toLocaleString()}`;
      }

      
      searchInput.addEventListener('input', () => {
        const q = searchInput.value.trim().toLowerCase();
        if (!q) {
          renderList(phones);
          updateSummaries(phones);
          return;
        }
        const filtered = phones.filter(p => {
          return (p.brand || '').toLowerCase().includes(q)
            || (p.model || '').toLowerCase().includes(q)
            || String(p.price || '').toLowerCase().includes(q)
            || String(p.phoneid).includes(q);
        });
        renderList(filtered);
        updateSummaries(filtered);
      });

      cancelBtn.addEventListener('click', () => {
        closeForm();
      });

      function openEdit(p) {
        currentEditingPhone = p;
        formSection.classList.remove('hidden');
        document.getElementById('phoneid').value = String(p.phoneid || '');
        document.getElementById('brand').value = p.brand || '';
        document.getElementById('model').value = p.model || '';
        document.getElementById('price').value = Number(p.price) || 0;
        formTitle.textContent = 'Edit Phone';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function closeForm() {
        formSection.classList.add('hidden');
        phoneForm.reset();
        currentEditingPhone = null;
      }

      
      phoneForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
      
        const payload = {
          ...currentEditingPhone,
          phoneid: currentEditingPhone.phoneid, 
          brand: document.getElementById('brand').value.trim(),
          model: document.getElementById('model').value.trim(),
          price: Number(document.getElementById('price').value)
        };

        try {
          const res = await fetch('/api/phones/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (res.ok) {
            await loadPhones();
            closeForm();
          } else {
            const err = await res.json().catch(()=>({message:'Unknown error'}));
            alert('Update failed: ' + (err.message || JSON.stringify(err)));
          }
        } catch (err) {
          console.error('Update error', err);
          alert('Update failed, check console.');
        }
      });

      
      function escapeHtml(s) {
        if (!s) return '';
        return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
      }

      function brandColor(brand) {
        const palette = ['#0ea5e9','#10b981','#f97316','#f472b6','#f59e0b','#8b5cf6','#fb7185','#60a5fa','#fca5a5','#86efac'];
        if (!brand) return '#475569';
        let hash = 0;
        for (let i = 0; i < brand.length; i++) hash = brand.charCodeAt(i) + ((hash << 5) - hash);
        const idx = Math.abs(hash) % palette.length;
        return palette[idx];
      }
      loadPhones();
    })();
  </script>
</body>
</html>